<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
<head>
  <meta charset="utf-8" />
  <meta name="generator" content="pandoc" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes" />
  <meta name="author" content="April 21, 2021" />
  <title>Introduction to Containers: Creating Reproducible, Scalable, and Portable Workflows</title>
  <style>
    html {
      line-height: 1.5;
      font-family: Georgia, serif;
      font-size: 20px;
      color: #1a1a1a;
      background-color: #fdfdfd;
    }
    body {
      margin: 0 auto;
      max-width: 36em;
      padding-left: 50px;
      padding-right: 50px;
      padding-top: 50px;
      padding-bottom: 50px;
      hyphens: auto;
      word-wrap: break-word;
      text-rendering: optimizeLegibility;
      font-kerning: normal;
    }
    @media (max-width: 600px) {
      body {
        font-size: 0.9em;
        padding: 1em;
      }
    }
    @media print {
      body {
        background-color: transparent;
        color: black;
        font-size: 12pt;
      }
      p, h2, h3 {
        orphans: 3;
        widows: 3;
      }
      h2, h3, h4 {
        page-break-after: avoid;
      }
    }
    p {
      margin: 1em 0;
    }
    a {
      color: #1a1a1a;
    }
    a:visited {
      color: #1a1a1a;
    }
    img {
      max-width: 100%;
    }
    h1, h2, h3, h4, h5, h6 {
      margin-top: 1.4em;
    }
    h5, h6 {
      font-size: 1em;
      font-style: italic;
    }
    h6 {
      font-weight: normal;
    }
    ol, ul {
      padding-left: 1.7em;
      margin-top: 1em;
    }
    li > ol, li > ul {
      margin-top: 0;
    }
    blockquote {
      margin: 1em 0 1em 1.7em;
      padding-left: 1em;
      border-left: 2px solid #e6e6e6;
      color: #606060;
    }
    code {
      font-family: Menlo, Monaco, 'Lucida Console', Consolas, monospace;
      font-size: 85%;
      margin: 0;
    }
    pre {
      margin: 1em 0;
      overflow: auto;
    }
    pre code {
      padding: 0;
      overflow: visible;
    }
    .sourceCode {
     background-color: transparent;
     overflow: visible;
    }
    hr {
      background-color: #1a1a1a;
      border: none;
      height: 1px;
      margin: 1em 0;
    }
    table {
      margin: 1em 0;
      border-collapse: collapse;
      width: 100%;
      overflow-x: auto;
      display: block;
      font-variant-numeric: lining-nums tabular-nums;
    }
    table caption {
      margin-bottom: 0.75em;
    }
    tbody {
      margin-top: 0.5em;
      border-top: 1px solid #1a1a1a;
      border-bottom: 1px solid #1a1a1a;
    }
    th {
      border-top: 1px solid #1a1a1a;
      padding: 0.25em 0.5em 0.25em 0.5em;
    }
    td {
      padding: 0.125em 0.5em 0.25em 0.5em;
    }
    header {
      margin-bottom: 4em;
      text-align: center;
    }
    #TOC li {
      list-style: none;
    }
    #TOC a:not(:hover) {
      text-decoration: none;
    }
    code{white-space: pre-wrap;}
    span.smallcaps{font-variant: small-caps;}
    span.underline{text-decoration: underline;}
    div.column{display: inline-block; vertical-align: top; width: 50%;}
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
    ul.task-list{list-style: none;}
    pre > code.sourceCode { white-space: pre; position: relative; }
    pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
    pre > code.sourceCode > span:empty { height: 1.2em; }
    code.sourceCode > span { color: inherit; text-decoration: inherit; }
    div.sourceCode { margin: 1em 0; }
    pre.sourceCode { margin: 0; }
    @media screen {
    div.sourceCode { overflow: auto; }
    }
    @media print {
    pre > code.sourceCode { white-space: pre-wrap; }
    pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
    }
    pre.numberSource code
      { counter-reset: source-line 0; }
    pre.numberSource code > span
      { position: relative; left: -4em; counter-increment: source-line; }
    pre.numberSource code > span > a:first-child::before
      { content: counter(source-line);
        position: relative; left: -1em; text-align: right; vertical-align: baseline;
        border: none; display: inline-block;
        -webkit-touch-callout: none; -webkit-user-select: none;
        -khtml-user-select: none; -moz-user-select: none;
        -ms-user-select: none; user-select: none;
        padding: 0 4px; width: 4em;
        color: #aaaaaa;
      }
    pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
    div.sourceCode
      {   }
    @media screen {
    pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
    }
    code span.al { color: #ff0000; font-weight: bold; } /* Alert */
    code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
    code span.at { color: #7d9029; } /* Attribute */
    code span.bn { color: #40a070; } /* BaseN */
    code span.bu { } /* BuiltIn */
    code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
    code span.ch { color: #4070a0; } /* Char */
    code span.cn { color: #880000; } /* Constant */
    code span.co { color: #60a0b0; font-style: italic; } /* Comment */
    code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
    code span.do { color: #ba2121; font-style: italic; } /* Documentation */
    code span.dt { color: #902000; } /* DataType */
    code span.dv { color: #40a070; } /* DecVal */
    code span.er { color: #ff0000; font-weight: bold; } /* Error */
    code span.ex { } /* Extension */
    code span.fl { color: #40a070; } /* Float */
    code span.fu { color: #06287e; } /* Function */
    code span.im { } /* Import */
    code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
    code span.kw { color: #007020; font-weight: bold; } /* Keyword */
    code span.op { color: #666666; } /* Operator */
    code span.ot { color: #007020; } /* Other */
    code span.pp { color: #bc7a00; } /* Preprocessor */
    code span.sc { color: #4070a0; } /* SpecialChar */
    code span.ss { color: #bb6688; } /* SpecialString */
    code span.st { color: #4070a0; } /* String */
    code span.va { color: #19177c; } /* Variable */
    code span.vs { color: #4070a0; } /* VerbatimString */
    code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
    .display.math{display: block; text-align: center; margin: 0.5rem auto;}
  </style>
  <!--[if lt IE 9]>
    <script src="//cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv-printshiv.min.js"></script>
  <![endif]-->
</head>
<body>
<header id="title-block-header">
<h1 class="title">Introduction to Containers: Creating Reproducible, Scalable, and Portable Workflows</h1>
<p class="author">April 21, 2021</p>
<p class="date">Nicolas Chan, Wei Feinstein, Oliver Muellerklein, and Chris Paciorek</p>
</header>
<h1 id="upcoming-events-and-hiring">Upcoming events and hiring</h1>
<ul>
<li><p>Looking for researchers working with sensitive data as we are building tools and services to support that work. Get in touch for more information.</p></li>
<li><p>Research IT is hiring graduate and undergraduate students for a variety of positions. Please talk to Amy Neeser to get more information.</p></li>
<li><p><a href="https://www.meetup.com/ucberkeley_cloudmeetup/">Cloud Computing Meetup</a> (monthly, with next meeting April 29 at 1 pm)</p></li>
<li><p><a href="https://dlab.berkeley.edu/working-groups/securing-research-data-working-group">Securing Research Data Working Group</a> (monthly, with next meeting May 10 at 2 pm)</p></li>
</ul>
<h1 id="introduction">Introduction</h1>
<p>We’ll do this mostly as a demonstration. We encourage you to login to your account and try out the various examples yourself as we go through them.</p>
<p>The materials for this tutorial are available using git at the short URL (<a href="https://tinyurl.com/brc-apr21">tinyurl.com/brc-apr21</a>), the GitHub URL (<a href="https://github.com/ucb-rit/savio-training-containers-2021">https://github.com/ucb-rit/savio-training-containers-2021</a>), or simply as a <a href="https://github.com/ucb-rit/savio-training-containers-2021/archive/main.zip">zip file</a>.</p>
<h1 id="outline">Outline</h1>
<p>This training session will cover the following topics:</p>
<ul>
<li>Introduction to containers
<ul>
<li>Comparison with VMs</li>
<li>Docker and Singularity</li>
<li>Advantages of containers</li>
</ul></li>
<li>Basic usage of containers
<ul>
<li>Demo of running a Singularity container</li>
<li>More details on running a container</li>
<li>Use with Slurm</li>
<li>Sources of images</li>
</ul></li>
</ul>
<p>(need to add outline items for Wei, Oliver, Nicolas sections)</p>
<h1 id="what-is-a-container">What is a container?</h1>
<ul>
<li>Containerization provides “lightweight, standalone, executable packages of software that include everything needed to run an application: code, runtime, system tools, system libraries and settings”.</li>
<li>A container provides a self-contained (isolated) filesystem.</li>
<li>Containers are similar to virtual machines in some ways, but much lighter-weight.</li>
<li>Containers are portable, shareable, and reproducible.</li>
</ul>
<h1 id="terminologyoverview">Terminology/Overview</h1>
<ul>
<li>image: a bundle of files, including the operating system, system libraries, software, and possibly data and files associated with the software
<ul>
<li>may be stored as a single file (e.g., Singularity) or a group of files (e.g., Docker)</li>
</ul></li>
<li>container: a virtual environment based on an image (i.e., a running instance of an image)
<ul>
<li>software running in the container sees this environment</li>
</ul></li>
<li>registry: a source of images</li>
</ul>
<h1 id="terminologyoverview-take-2">Terminology/Overview, take 2</h1>
<center>
<img src="taxonomy-of-docker-terms-and-concepts.png">
</center>
<p>(Image from docs.microsoft.com)</p>
<h1 id="containers-versus-vms">Containers versus VMs</h1>
<p>Let’s see a schematic of what is going on with a container.</p>
<center>
<img src="vm_vs_container.png">
</center>
<p>(Image from Tin Ho, github.com/tin6150)</p>
<p>VMs have a copy of the entire operating system and need to be booted up, while containers use the Linux kernel of the host machine and processes running in the container can be seen as individual processes on the host.</p>
<h1 id="why-use-containers">Why use containers?</h1>
<ul>
<li>Portability - install once, run “anywhere”.</li>
<li>Control your environment/software on systems (such as Savio, XSEDE) you don’t own.</li>
<li>Manage complex dependencies/installations by using containers for modular computational workflows/pipelines, one workflow per container.</li>
<li>Provide a reproducible environment:
<ul>
<li>for yourself in the future,</li>
<li>for others (lab members),</li>
<li>for software you develop and want to distribute,</li>
<li>for a publication.</li>
</ul></li>
<li>Flexibility in using various software or application versions:
<ul>
<li>use outdated or updated versions of software or OS</li>
<li>use an OS you don’t have.</li>
<li>test your code on various configurations or OSes.</li>
</ul></li>
<li>High performance compared to VMs.</li>
</ul>
<p>Much of this comes down to the fact that your workflow can depend in a fragile way on one or more pieces of software that may be difficult to install or keep operational.</p>
<h1 id="limitations-of-containers">Limitations of containers</h1>
<ul>
<li>Another level of abstraction/indirection can be confusing
<ul>
<li>‘Where’ am I?</li>
<li>Where are my files?</li>
</ul></li>
<li>Can run into host-container incompatibilities (e.g., MPI, GPUs)</li>
<li>Limitations in going between CPU architectures (e.g., x86_64 versus ARM)</li>
</ul>
<h1 id="docker-vs.-singularity">Docker vs. Singularity</h1>
<p>What is Docker?</p>
<ul>
<li>Open-source computer software that encapsulates an application and all its dependencies into a single image, as a series of layers</li>
<li>Brings containerization to the individuals on their own machines</li>
<li>Rich image repository</li>
<li>Widely used by scientific communities</li>
<li>Security concerns make it unsuitable for the HPC environment</li>
<li>By default you are root in the container</li>
</ul>
<p>What is Singularity?</p>
<ul>
<li>Open-source computer software that encapsulates an application and all its dependencies into a single image, as a single file</li>
<li>Brings containerization to Linux clusters and HPC</li>
<li>Developed at LBL by Greg Kurtzer</li>
<li>Typically users have a machine on which they have admin privileges and can’t build images but don’t have admin privileges where the containers are run</li>
<li>You are yourself (from the host machine) in the container</li>
</ul>
<p>How can Singularity can leverage Docker?</p>
<ul>
<li>Create and run a Singularity container based on a Docker image</li>
<li>(transform a Dockerfile?)</li>
<li>Create Singularity images by running Singularity in a Docker container</li>
<li>other?</li>
</ul>
<h1 id="examples-of-where-containers-are-used">Examples of where containers are used</h1>
<ul>
<li>Kubernetes runs pods based on Docker images</li>
<li>MyBinder creates an executable environment by building a Docker image</li>
<li>You can have GitHub Actions and Bitbucket Pipelines in a Docker container</li>
<li>CodeOcean capsules are built on Docker images</li>
</ul>
<h1 id="running-pre-existing-containers-using-singularity">Running pre-existing containers using Singularity</h1>
<ul>
<li>No root/sudo privilege is needed</li>
<li>Create/download immutable squashfs images/containers</li>
</ul>
<pre><code>singularity pull --help</code></pre>
<ul>
<li>DockerHub: Pull a container from DockerHub.</li>
</ul>
<pre><code>$ singularity pull docker://ubuntu:18.04 
$ singularity pull docker://rocker/r-base:latest
$ singularity pull docker://postgres
$ ls -lrt | tail -n 10   # careful of your quota!
$ ls -l ~/.singularity
$ singularity cache list</code></pre>
<pre><code>singularity run ubuntu_18.04.sif       # use downloaded image file
## alternatively, use ~/.singularity/cache
singularity run docker://ubuntu:18.04  </code></pre>
<p>Note the change in prompt.</p>
<pre><code>cat /etc/issue   # not the Savio OS!
which python     # not much here!
pwd
echo &quot;written from the container&quot; &gt; junk.txt
ls /global/scratch/paciorek | head -n 5
exit
cat junk.txt</code></pre>
<pre><code>singularity run docker://rocker/r-base    # easy!
singularity run docker://postgres         # sometimes things are complicated!</code></pre>
<h1 id="other-ways-of-running-a-container">Other ways of running a container</h1>
<ul>
<li>Singularity Hub: If no tag is specified, the master branch of the repository is used</li>
</ul>
<pre><code>$ singularity pull hello-world.sif shub://singularityhub/hello-world
$ singularity run hello-world.sif</code></pre>
<p>Here’s how one runs a Docker container (on a system where you have admin access):</p>
<pre><code>echo $HOME
docker run -it --rm rocker/r-base bash
pwd
ls /accounts/gen/vis/paciorek    # no automatic mount of my host home directory</code></pre>
<h1 id="different-ways-of-using-a-singularity-container">Different ways of using a Singularity container</h1>
<ul>
<li><strong>shell</strong> sub-command: invokes an interactive shell within a container</li>
</ul>
<pre><code>singularity shell hello-world.sif</code></pre>
<ul>
<li><strong>run</strong> sub-command: executes the container’s runscript</li>
</ul>
<pre><code>singularity run hello-world.sif</code></pre>
<ul>
<li><strong>exec</strong> sub-command: execute an arbitrary command within container</li>
</ul>
<pre><code>singularity exec hello-world.sif cat /etc/os-release</code></pre>
<pre><code>singularity inspect -r hello-world.sif</code></pre>
<h1 id="container-processes-on-the-host-system">Container processes on the host system</h1>
<p>Let’s see how the container processes show up from the perspective of the host OS.</p>
<p>We’ll run some intensive linear algebra in R.</p>
<pre><code>singularity run docker://rocker/r-base:latest</code></pre>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">rnorm</span>(<span class="dv">10000</span><span class="sc">^</span><span class="dv">2</span>), <span class="dv">10000</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="fu">system.time</span>(<span class="fu">chol</span>(<span class="fu">crossprod</span>(a)))</span></code></pre></div>
<p>We see in <code>top</code> that the R process running in the container shows up as an R process on the host.</p>
<h1 id="accessing-the-savio-filesystems-and-bind-paths">Accessing the Savio filesystems and bind paths</h1>
<ul>
<li>Singularity allow mapping directories on host to directories within container</li>
<li>Easy data access within containers</li>
<li>System-defined bind paths on Savio
<ul>
<li><code>/global/home/users/</code></li>
<li><code>/global/scratch/</code></li>
<li><code>/tmp</code></li>
</ul></li>
<li>User can define own bind paths:
<ul>
<li>mount /host/path/ on the host to /container/path inside the container</li>
<li><code>-B /host/path/:/container/path</code></li>
</ul></li>
</ul>
<pre><code>ls /global/scratch/paciorek/wikistats_small
singularity shell -B /global/scratch/paciorek/wikistats_small:/data hello-world.sif
ls /data
touch /data/erase-me
exit
ls -l /global/scratch/paciorek/wikistats_small</code></pre>
<p>In general one would do I/O to data on the host system rather than writing into the container.</p>
<p>It is possible to create writeable containers.</p>
<h1 id="running-containers-on-savio-via-slurm">Running containers on Savio via Slurm</h1>
<p>You can run Singularity within an <code>sbatch</code> or <code>srun</code> session.</p>
<p>Here’s a basic job script.</p>
<pre><code>#!/bin/bash 
#SBATCH --job-name=container-test        
#SBATCH --partition=savio2       
#SBATCH --account=co_stat                   
#SBATCH --time=5:00     

singularity exec hello-world.sif cat /etc/os-release</code></pre>
<h1 id="sources-of-container-images-registries">Sources of container images (registries)</h1>
<ul>
<li><a href="https://hub.docker.com">DockerHub</a></li>
<li><a href="https://singularity-hub.org">SingularityHub (future is up in the air)</a></li>
<li><a href="https://cloud.sylabs.io/library">Sylabs container registry</a></li>
</ul>
<p>DockerHub images are named liked this: OWNER/CONTAINERNAME:TAG.</p>
<p>Let’s see an <a href="https://hub.docker.com/u/continuumio">example of the Continuum images</a>.</p>
<p>(For images provided by Docker, you don’t specify the OWNER.)</p>
<h1 id="singularity-workflow-leading-into-nicolas-material">Singularity workflow (leading into Nicolas’ material)</h1>
<ul>
<li><a href="https://docs.google.com/document/d/10XAtH9yj5uyiHr3eGHTk9h82bZXEp0aixMCmgYJhGNQ/edit?usp=sharing">install Singularity locally</a> (or build an image in the cloud)</li>
<li>transfer image to Savio</li>
<li>run container on Savio</li>
</ul>
<h1 id="nicolas-content">Nicolas’ content</h1>
<h1 id="approaches-to-building">Approaches to Building</h1>
<ul>
<li>Build a Docker image and convert
<ul>
<li>Convenient if you already have a Docker build file</li>
</ul></li>
<li>Build from Singularity definition file
<ul>
<li>Bootstrap from another Singularity container or non-Docker base OS</li>
<li>Alows extra customization with directives</li>
</ul></li>
</ul>
<h1 id="building-a-docker-container">Building a Docker container</h1>
<pre class="docker"><code>FROM ubuntu:18.04
RUN mkdir -p /app</code></pre>
<ul>
<li>TODO: cover ENTRYPOINT and CMD</li>
</ul>
<h1 id="pushing-to-docker-registry">Pushing to Docker Registry</h1>
<p>TODO</p>
<h1 id="converting-docker-to-singularity">Converting Docker to Singularity</h1>
<ul>
<li><code>singularity run docker://...</code></li>
<li><code>singularity build test.simg docker://</code></li>
</ul>
<p>Reference: https://github.com/ucb-rit/savio-singularity-template/blob/master/build_examples.md</p>
<h1 id="singularity-definition-file">Singularity Definition File</h1>
<ol type="1">
<li><strong>Header</strong>: Base to build the container off of, such as an existing Docker/Singularity/OS image</li>
<li><strong>Sections</strong>: Denoted by a <code>%</code> which are executed once the container is built to configure it</li>
</ol>
<p>Reference: https://sylabs.io/guides/3.0/user-guide/definition_files.html</p>
<h1 id="singularity-build-example">Singularity Build Example</h1>
<ul>
<li>Building simple archlinux asciiquarium image: <code>arch-example.def</code></li>
<li><code>%setup</code>: Executed on host system before container is built</li>
<li><code>%environment</code>: Set environment variables in the container</li>
<li><code>%post</code>: Executed within the container at build time</li>
<li><code>%runscript</code>: Executed with <code>singularity run busybox-example.simg</code> or <code>./busybox-example.simg</code></li>
</ul>
<p>Reference: https://github.com/ucb-rit/savio-singularity-template</p>
<h1 id="singularity-build-example-demo">Singularity Build Example (demo)</h1>
<ul>
<li><code>sudo singularity build alpine-example.simg alpine-example.def</code></li>
<li><code>singularity run alpine-example.simg</code></li>
<li><code>scp alpine-example.simg nicolaschan@dtn.brc.berkeley.edu:.</code></li>
<li>On Savio: <code>singularity run alpine-example.simg</code></li>
<li>On Savio: <code>singularity exec alpine-example.simg sh</code>
<ul>
<li><code>echo $MY_VAR_VALUE</code></li>
</ul></li>
</ul>
<h1 id="singularity-build-options">Singularity Build Options</h1>
<ul>
<li>Install Singularity locally</li>
<li>Install Docker locally and use singularity-docker
<ul>
<li>https://github.com/singularityhub/singularity-docker</li>
</ul></li>
<li>Build an image on a cloud service or continuous integration host
<ul>
<li>Sylabs Remote Builder: https://cloud.sylabs.io/builder</li>
</ul></li>
</ul>
<h1 id="rewritablesandbox-singularity-images">Rewritable/Sandbox Singularity Images</h1>
<p>TODO</p>
<h1 id="pushing-to-singularity-registry">Pushing to Singularity Registry</h1>
<p>TODO</p>
<h1 id="weis-content">Wei’s content</h1>
<h1 id="outline-of-mpi-and-gpu-containers">Outline of MPI and GPU Containers</h1>
<ul>
<li><p>MPI (Message Passing Interface) applications can utilize multiple nodes</p></li>
<li><p>Build and run MPI containers</p>
<ul>
<li>Single node only</li>
<li>Cross multiple nodes: Rely on the MPI implementation available on the host</li>
</ul></li>
<li><p>MPI library version compatibility on the host and within containers</p></li>
<li><p>Build GPU containers from a docker at NGC</p></li>
<li><p>Run GPU containers</p></li>
<li><p>NVIDIA driver and CUDA version compatibility</p></li>
</ul>
<h1 id="build-mpi-singularity-containers">Build MPI singularity containers</h1>
<ul>
<li>MPI application example: <a href="samples/mpitest.c">mpitest.c</a></li>
</ul>
<pre><code>[wfeinstein@n0000 singularity-test]$ cat host 
n0098.lr6
n0099.lr6

[wfeinstein@n0000 singularity]$ mpirun -np 4  --hostfile host mpitest
...
Hello, I am on n0098.lr6 rank 3/4
Hello, I am on n0098.lr6 rank 3/4
Hello, I am on n0099.lr6 rank 2/4
Hello, I am on n0099.lr6 rank 2/4
...</code></pre>
<ul>
<li><p>Definition file<br />
<a href="samples/SINGULARITY-mpi3.1.0.def">SINGULARITY-mpi3.1.0.def</a></p></li>
<li><p>Build MPI container locally</p></li>
</ul>
<pre><code>sudo singularity build mpi3.1.0.sif SINGULARITY-mpi3.1.0.def</code></pre>
<ul>
<li>Transfer mpi3.1.0.sif to your perferred cluster</li>
<li>Check out the container</li>
</ul>
<pre><code>[wfeinstein@n0000 singularity-test]$ singularity shell mpi3.1.0.sif         
Singularity mpi3.1.0.sif:/global/scratch/wfeinstein/singularity-test&gt; ls /opt/
mpitest  mpitest.c  ompi

Singularity mpi3.1.0.sif:/global/scratch/wfeinstein/singularity-test&gt; /opt/ompi/bin/mpirun --version
mpirun (Open MPI) 3.1.0

Singularity mpi3.1.0.sif:/global/scratch/wfeinstein/singularity-test&gt; /opt/ompi/bin/mpirun -np 2 /opt/mpitest
Hello, I am on n0000.scs00 rank 0/2
Hello, I am on n0000.scs00 rank 1/2</code></pre>
<h1 id="run-mpi-containers">Run MPI containers</h1>
<ul>
<li>Use MPI libaries soly within a constainer</li>
<li>MPI tasks are launched within a container, no dependece on host, however can’t expand to multiple nodes</li>
</ul>
<pre><code>[wfeinstein@n0000 singularity-test]$ singularity exec mpi3.1.0.sif  /opt/ompi/bin/mpirun -np 2 /opt/mpitest
Hello, I am on n0000.scs00 rank 0/2
Hello, I am on n0000.scs00 rank 1/2

[wfeinstein@n0000 singularity-test]$ module list
No Modulefiles Currently Loaded.</code></pre>
<ul>
<li>Rely on the MPI implementation available on the host</li>
<li>Can expand to multple nodes</li>
</ul>
<pre><code>[wfeinstein@n0000 singularity-test]$ mpirun -np 64 --hostfile host singularity exec mpi3.1.0.sif /opt/mpitest
...
Hello, I am on n0099.lr6 rank 34/64
Hello, I am on n0098.lr6 rank 27/64
Hello, I am on n0099.lr6 rank 41/64
Hello, I am on n0098.lr6 rank 31/64
...
[wfeinstein@n0000 singularity-test]$ module list
Currently Loaded Modulefiles:
  1) gcc/9.2.0           2) openmpi-gcc/3.1.0</code></pre>
<h1 id="mpi-version-compatibility-1">MPI version compatibility (1)</h1>
<ul>
<li>Mismatch of MPI libaries on the host and within the container break containers</li>
<li>Extra caution to ensure MPI library compatibity</li>
</ul>
<pre><code>[wfeinstein@n0000 singularity-test]$ ls  *.sif
mpi2.0.4.sif  mpi3.0.1.sif  mpi3.1.0.sif  mpi4.0.1.sif

[wfeinstein@n0000 singularity-test]$ module list
Currently Loaded Modulefiles:
  1) gcc/9.2.0           2) openmpi/4.0.1-gcc

[wfeinstein@n0000 singularity-test]$ mpirun -np 4 --hostfile host singularity exec mpi3.0.1.sif /opt/mpitest
Hello, I am on n0098.lr6 rank 2/4
Hello, I am on n0098.lr6 rank 1/4
Hello, I am on n0098.lr6 rank 3/4
Hello, I am on n0098.lr6 rank 0/4

[wfeinstein@n0000 singularity-test]$ mpirun -np 4 --hostfile host singularity exec mpi4.0.1.sif /opt/mpitest
Hello, I am on n0098.lr6 rank 2/4
Hello, I am on n0098.lr6 rank 1/4
Hello, I am on n0098.lr6 rank 3/4
Hello, I am on n0098.lr6 rank 0/4

[wfeinstein@n0000 singularity-test]$ mpirun -np 4 --hostfile host singularity exec mpi2.0.4.sif /opt/mpitest
--------------------------------------------------------------------------
It looks like MPI_INIT failed for some reason; your parallel process is
likely to abort.  There are many reasons that a parallel process can
....</code></pre>
<h1 id="mpi-version-compatibility-2">MPI version compatibility (2)</h1>
<pre><code>[wfeinstein@n0000 singularity-test]$ module list
Currently Loaded Modulefiles:
  1) gcc/6.3.0           2) openmpi/3.0.1-gcc

[wfeinstein@n0000 singularity-test]$ mpirun -np 4 --hostfile host singularity exec mpi3.0.1.sif /opt/mpitest
Hello, I am on n0098.lr6 rank 2/4
Hello, I am on n0098.lr6 rank 3/4
Hello, I am on n0098.lr6 rank 0/4
Hello, I am on n0098.lr6 rank 1/4

[wfeinstein@n0000 singularity-test]$ mpirun -np 4 --hostfile host singularity exec mpi4.0.1.sif /opt/mpitest
[n0098.lr6:115220] PMIX ERROR: OUT-OF-RESOURCE in file client/pmix_client.c at line 225
[n0098.lr6:115220] OPAL ERROR: Error in file pmix3x_client.c at line 112
...</code></pre>
<h1 id="gpu-contrainers">GPU contrainers</h1>
<ul>
<li>Singularity supports NVIDIA’s CUDA GPU compute framework or AMD’s ROCm solution</li>
<li>Userspace NVIDIA driver components from the host are dynamically mounted in the container at runtime
<ul>
<li>–nv enables NVIDIA GPU support by providing the driver on the host</li>
</ul></li>
<li>NVIDIA driver not present in the container image itself</li>
<li>Application built against a CUDA toolchain has a minimal host NVIDIA driver requirement
<ul>
<li>e.g., CUDA/11.2 requires NVIDIA drivr &gt;= R450</li>
</ul></li>
<li>Host driver version requirements are detailed in <a href="https://docs.nvidia.com/deploy/cuda-compatibility/index.html">NGC documentation</a></li>
</ul>
<h1 id="gpu-container-examples">GPU container examples</h1>
<ul>
<li>Build PyTorch GPU container from <a href="https://ngc.nvidia.com/catalog/containers/nvidia:pytorch">PyTorch docker NGC</a></li>
</ul>
<pre><code>docker pull nvcr.io/nvidia/pytorch:21.03-py3:21.03-py3
singularity build pytorch_21.03_py3.sif docker-daemon://nvcr.io/nvidia/pytorch:21.03-py3</code></pre>
<ul>
<li>Run PyTorch on a GPU node</li>
</ul>
<pre><code>[wfeinstein@n0043 pytorch]$ nvidia-smi -L
GPU 0: Tesla V100-SXM2-32GB (UUID: GPU-df6fb04c-b0a4-69cc-98a2-763783d4e152)
GPU 1: Tesla V100-SXM2-32GB (UUID: GPU-3c41dc39-df54-1582-4d27-6c8454ed96c6)

[wfeinstein@n0043 singularity-test]$ nvidia-smi
Mon Apr 19 00:32:43 2021       
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 440.44       Driver Version: 440.44       CUDA Version: 10.2     |
...

[wfeinstein@n0043 pytorch]$ singularity exec --nv pytorch_21.03_py3.sif python -c &quot;import torch; print(torch.__version__);print(torch.cuda.get_device_name(0)); print(torch.version.cuda)&quot;
1.9.0a0+df837d0
Tesla V100-SXM2-32GB
11.2

[wfeinstein@n0043 singularity-test]$ singularity exec --nv ../pytorch/pytorch_19_12_py3.sif  python -c &quot;import torch; print(torch.__version__);print(torch.cuda.get_device_name(0)); print(torch.version.cuda)&quot;
1.4.0a0+a5b4d78
Tesla V100-SXM2-32GB
10.2
</code></pre>
<h1 id="olivers-content">Oliver’s content</h1>
<h1 id="other-container-resources">Other container resources</h1>
<ul>
<li><a href="https://education.sdsc.edu/training/interactive/202101_intro_to_singularity/">San Diego supercomputing center training</a></li>
<li><a href="https://github.com/XSEDE/Container_Tutorial">XSEDE tutorial</a></li>
<li><a href="https://carpentries-incubator.github.io/docker-introduction/index.html">Software Carpentries Docker training</a></li>
<li><a href="https://carpentries-incubator.github.io/singularity-introduction/">Software Carpentries Singularity training</a></li>
</ul>
<p>(any others?)</p>
<h1 id="how-to-get-additional-help">How to get additional help</h1>
<ul>
<li>Check the Status and Announcements page:
<ul>
<li><a href="https://research-it.berkeley.edu/services/high-performance-computing/status-and-announcements">https://research-it.berkeley.edu/services/high-performance-computing/status-and-announcements</a></li>
</ul></li>
<li>For technical issues and questions about using Savio:
<ul>
<li>brc-hpc-help@berkeley.edu</li>
</ul></li>
<li>For questions about computing resources in general, including cloud computing:
<ul>
<li>brc@berkeley.edu</li>
<li>office hours: office hours: Wed. 1:30-3:00 and Thur. 9:30-11:00 <a href="https://research-it.berkeley.edu/programs/berkeley-research-computing/research-computing-consulting">on Zoom</a></li>
</ul></li>
<li>For questions about data management (including HIPAA-protected data):
<ul>
<li>researchdata@berkeley.edu</li>
<li>office hours: office hours: Wed. 1:30-3:00 and Thur. 9:30-11:00 <a href="https://research-it.berkeley.edu/programs/berkeley-research-computing/research-computing-consulting">on Zoom</a></li>
</ul></li>
</ul>
</body>
</html>
